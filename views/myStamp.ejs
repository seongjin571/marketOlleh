<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Page Title</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script src="/javascripts/spin.js"></script>
    <link rel="stylesheet" href="/stylesheets/swiper.min.css">
  <link rel="stylesheet" type="text/css" href="/stylesheets/stamp.css" />
  <!-- <script type='application/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js'></script> -->
  <!-- <script>
  window.addEventListener('load', function () {
    FastClick.attach(document.body);
  }, false);
  </script> -->
</head>

<body>
  <script>
    window.onload = function() {
      if(localStorage.getItem('reviewTab')) {
        var review_tab = 'store_review_sj' + localStorage.getItem('reviewTab');
        var stamp_detail = 'selected_stamp' + localStorage.getItem('reviewTab');
        var back = 'back_div' + localStorage.getItem('reviewTab');

        $('#myStamp').fadeOut('200');
        $('#'+stamp_detail).fadeIn('200');
        $('#'+review_tab).fadeIn('200');
        $('#'+back).fadeIn('200');

        localStorage.clear();
      }
    }
  </script>

  <div id="myStamp">
    <!-- <label>내 스탬프</label> -->
    <% if(myStamps) { %>
      <% for(var i=0; i<myStamps.length; i++) { %>
        <div class="stamp_one" id='stamp_list<%= myStamps[i].id %>'>

            <div class="store_market_name">
                <%= myStamps[i].market_name %>
            </div>
            <div class="my_stamp_count">
                <div class="stamp_count_vertical" id='stamp_count_vertical<%= myStamps[i].id %>'>
                    <p class="count_stamp">
                        <%= myStamps[i].stamp_count %>&nbsp/
                            <%= myStamps[i].stamp_standard %>
                    </p>
                </div>
            </div>
            <div class="stamp_market">
                    <p class="deadline">
                        <%= myStamps[i].sijang_name %>
                    </p>
                    <div class="logo_image">
                    <img src="/images/inline-logo.png" width="75%" height="auto" style="padding-top: 12%;padding-left: 8%;">
                </div>
            </div>
        </div>
        <% } %>
        <% } else { %>
          <div class='stamp_list'>
            <div id="no_stamp">발급받은 스탬프가 없습니다.</div>
          </div>
          <% } %>
        </div>


        <% if(myStamps) { %>
          <div id='stamp_details'>
          <% for(var i=0; i<myStamps.length; i++) { %>

            <div class='selected_stamp' id="selected_stamp<%= myStamps[i].id %>">
                <div class="back_div" id="back_div<%= myStamps[i].id %>">
                    <img id="tableControl<%= myStamps[i].id %>" src="/images/backButton_blue.png" width="20px" height="20px">
                </div>
                <div id="menu_infor">
                <div id="top_infor">
                  <div id="name_sj">
                    <p id="store_name_sj">
                      <%= myStamps[i].market_name %>
                    </p>
                    <p id="market_name_sj">
                      <%= myStamps[i].sijang_name %>
                    </p>
                  </div>
                  <div id="sns_sj">
                    <div id="good">
                      <% if(! myStamps[i].like_check) { %>
                        <img class='top_image' id="noGood_Button_sj<%= myStamps[i].id %>" src="/images/nolikeM.png" width="30px" height="30px" style='display: block;'>
                        <img class='top_image' id="yesGood_Button_sj<%= myStamps[i].id %>" src="/images/likeM.png" width="30px" height="30px" style='display: none;'>
                      <% } else { %>
                        <img class='top_image' id="yesGood_Button_sj<%= myStamps[i].id %>" src="/images/likeM.png" width="30px" height="30px" style='display: block;'>
                        <img class='top_image' id="noGood_Button_sj<%= myStamps[i].id %>" src="/images/nolikeM.png" width="30px" height="30px" style='display: none;'>
                      <% } %>
                            <p class="top_font" id="goodCount_sj<%= myStamps[i].id %>">
                              <%= myStamps[i].like_count %>
                            </p>
                    </div>
                    <div id="kakao">
                      <img class="top_image" src="/images/kakao_bic.png" width="30px" height="30px">
                      <p class="top_font">공유하기</p>
                    </div>
                    <div id="face">
                      <img class="top_image" src="/images/face.png" width="30px" height="30px">
                      <p class="top_font">공유하기</p>
                    </div>
                  </div>
                </div>
                <div id="bottom_infor">
                  <p id="go_store_detail_sj">스탬프</p>
                  <p id="go_store_detail_sj">상점정보</p>
                  <p id="go_store_review_sj">리뷰</p>
                  <p id="go_store_review_sj">리뷰작성</p>
                </div>
        </div>


              <div class="swiper-container" id="<%= myStamps[i].id %>">
                  <div class="swiper-wrapper" id="<%= myStamps[i].id %>">
            <div class="swiper-slide" id="swiper1<%= myStamps[i].id %>">
              <div class='stamp_menu_sj' id="stamp_menu_sj<%= myStamps[i].id %>">
                <div class='stamp_sj' id="stamp_sj<%= myStamps[i].id %>">
                  <div class='tenControls_sj' id="tenControls_sj<%= myStamps[i].id %>">
                    <div class='tenStamp_sj' id="tenStamp_sj<%= myStamps[i].id %>">
                      <div class='tenStamp_top_sj' id="tenStamp_top_sj<%= myStamps[i].id %>">
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>1</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>2</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>3</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>4</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>5</p>
                        </div>
                      </div>
                      <div class='tenStamp_bottom_sj' id="tenStamp_bottom_sj<%= myStamps[i].id %>">
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>6</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>7</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>8</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>9</p>
                        </div>
                        <div class="ten_sj <%= myStamps[i].id %>">
                          <p>10</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class='fiveControls_sj' id="fiveControls_sj<%= myStamps[i].id %>">
                    <div class='fiveStamp_sj' id="fiveStamp_sj<%= myStamps[i].id %>">
                      <div class="five_sj <%= myStamps[i].id %>">
                        <p>1</p>
                      </div>
                      <div class="five_sj <%= myStamps[i].id %>">
                        <p>2</p>
                      </div>
                      <div class="five_sj <%= myStamps[i].id %>">
                        <p>3</p>
                      </div>
                      <div class="five_sj <%= myStamps[i].id %>">
                        <p>4</p>
                      </div>
                      <div class="five_sj <%= myStamps[i].id %>">
                        <p>5</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="stamp_infor">
                    <img src="/images/standard.png" width="30px" height="30px">
                    <div class="name">적립기준</div>
                    <div class="stamp_infor_content"><%= myStamps[i].market_promotion %></div>
                </div>

                <div class="stamp_infor">
                    <img src="/images/rewardM.png" width="30px" height="30px">
                    <div class="name">보상기준</div>
                    <div class="stamp_infor_content"><%= myStamps[i].stamp_reward %></div>
                </div>



                <button class='button_sj' id="delete_button_sj<%= myStamps[i].id %>">삭제</button>
              </div>
            </div>
              <div class='password_number_div_sj' id="password_number_div_sj<%= myStamps[i].id %>">
                <div class="password_check" id="password_check<%= myStamps[i].id %>">
                  <div class="check<%= myStamps[i].id %>"></div>
                  <div class="check<%= myStamps[i].id %>"></div>
                  <div class="check<%= myStamps[i].id %>"></div>
                  <div class="check<%= myStamps[i].id %>"></div>
                </div>
                <div class="password_line_sj <%= myStamps[i].id %>">
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                </div>
                <div class="password_line_sj <%= myStamps[i].id %>">
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                </div>
                <div class="password_line_sj <%= myStamps[i].id %>">
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                </div>
                <div class="password_line_sj <%= myStamps[i].id %>">
                  <div class='password_cancel' id="password_cancel<%= myStamps[i].id %>">취소</div>
                  <div class="password_number_sj <%= myStamps[i].id %>"></div>
                  <div class='password_ok' id="password_ok<%= myStamps[i].id %>"></div>
                </div>
              </div>
              <!-- </div> -->



              <div class="swiper-slide" id="swiper2<%= myStamps[i].id %>">
                  <div id="store_detail_sj">
                      <div class="store_image" style="background: url('/files/<%= myStamps[i].manager_image %>'); background-repeat: no-repeat; background-position: center center;"></div>
                      <div id="introduce">
                          <img src="/images/storeM.png" width="30px" height="30px">
                          <div class="name">상점소개</div>
                          <div id="intro_content"><%= myStamps[i].market_introduce %></div>
                      </div>
                      <div id="map">
                              <img src="/images/location2.png" width="30px" height="30px">
                              <div class="name">위치</div>
                      </div>
                      <img src="/images/han.png" width="80%" style="margin-left: 10%;margin-top: 5%;">
                  </div>
              </div>

              <div class="swiper-slide" id="swiper3<%= myStamps[i].id %>">
              <div class='store_review_sj' id="store_review_sj<%= myStamps[i].id %>">
                <div class="review_rate">
                  <div class="review_star">
                    <% if(review) { %>
                      <% for(var j=0; j<avgOfRate.length; j++) { %>
                        <% if(avgOfRate[j].market_name == myStamps[i].market_name && avgOfRate[j].sijang_name == myStamps[i].sijang_name && avgOfRate[j].rateCnt) { %>
                          <% for(var k=0; k<avgOfRate[j].avgRate; k++) { %>
                            <div>
                              <img class="star_yellow" src="/images/star_yellow.png" width="30px" height="30px">
                            </div>
                          <% } %>

                          <% for(var k=0; k<5-avgOfRate[j].avgRate; k++) { %>
                            <div>
                              <img class="star_gray" src="/images/star_gray.png" width="30px" height="30px">
                            </div>
                          <% } %>
                        <% } else if(avgOfRate[j].market_name == myStamps[i].market_name && avgOfRate[j].sijang_name == myStamps[i].sijang_name && ! avgOfRate[j].rateCnt) { %>
                          <% for(var k=0; k<5; k++) { %>
                            <div>
                              <img class="star_gray" src="/images/star_gray.png" width="30px" height="30px">
                            </div>
                          <% } %>
                        <% } %>
                      <% } %>
                    <% } else { %>
                      <% for(var k=0; k<5; k++) { %>
                        <div>
                          <img class="star_gray" src="/images/star_gray.png" width="30px" height="30px">
                        </div>
                      <% } %>
                    <% } %>
                  </div>
                  <div class="review_count">

                    <!-- <p style="font-size: 20px; color: #9c9c9c;">리뷰</p> -->
                    <% if(review) { %>
                      <% for(var j=0; j<avgOfRate.length; j++) { %>
                        <% if(avgOfRate[j].market_name == myStamps[i].market_name && avgOfRate[j].sijang_name == myStamps[i].sijang_name && avgOfRate[j].rateCnt) { %>
                          <p class="review_count_content" id='review_count_content<%= myStamps[i].id %>'><%= avgOfRate[j].rateCnt %></p>
                          <p style="font-size: 20px; color: #9c9c9c;">개의 리뷰가 있습니다.</p>
                        <% } else if(avgOfRate[j].market_name == myStamps[i].market_name && avgOfRate[j].sijang_name == myStamps[i].sijang_name && ! avgOfRate[j].rateCnt) { %>
                          <p style="font-size: 20px; color: #9c9c9c;">작성된 리뷰가 없습니다.</p>
                        <% } %>
                      <% } %>
                    <% } else { %>
                      <p style="font-size: 20px; color: #9c9c9c;">작성된 리뷰가 없습니다.</p>
                    <% } %>

                  </div>

                  <div id="intro">
                    <p>
                        <%= myStamps[i].market_name %> 상점을 이용하는 고객들의 리뷰입니다.
                    </p>
                  </div>
                  <div class="line">

                  </div>

                </div>


                <% if(review) {%>
                  <% for(var j=review.length-1; j>=0; j--) { %>
                    <% if(review[j].market_name == myStamps[i].market_name && review[j].sijang_name == myStamps[i].sijang_name) { %>

                <div class="review_div_sj" id='review_div_sj<%= myStamps[i].id %>'>
                    <div class="review_star_customer">
                        <% for(var k=0; k<review[j].rate; k++) { %>
                        <div>
                            <img class="star_yellow_customer" src="/images/star_yellow.png" width="20px" height="20px">
                        </div>
                        <% } %>

                        <% if(review[j].user_id != '사장님') {%>
                        <% for(var k2=0; k2<5-review[j].rate; k2++) { %>
                          <div>
                              <img class="star_gray_customer" src="/images/star_gray.png" width="20px" height="20px">
                          </div>
                        <% } %>
                        <% } %>
                    </div>
                  <div class="review_content_sj">
                    <div class="review_content_id_sj" id='review_content_id_sj<%= review[j].id %>'>
                      <script>
                      var temp = '<%= review[j].user_id %>';
                      var secret = '***';
                      var l = temp.length;
                      var f = l-3;
                      //console.log(f);
                      //console.log(l);
                      var temp2 = temp.substring(0,f);
                      var result3 = temp2.concat(secret);

                      if(result3 == '***'){
                        $('#review_content_id_sj<%= review[j].id %>').html('사장님');
                      }else{
                        $('#review_content_id_sj<%= review[j].id %>').html(result3);
                        console.log(result3);
                      }
                      //  console.log("아래");
                      //  console.log(result3);
                      </script>

                    </div>
                    <div class="review_content_date_sj">
                      <%= review[j].date %>
                    </div>
                  </div>
                  <p><%= review[j].review %></p>
                  <div class="line">
                    </div>
                </div>
                  <% } else {%>
                    <% } %>
                    <% } %>
                <% } else { %>
                  <!-- <div class='stamp_list'>
                    <div id="no_stamp">리뷰가 없습니다.</div>
                  </div> -->
                  <% } %>
              </div>
            </div>
              <div class="swiper-slide" id="swiper3<%= myStamps[i].id %>">
              <div class='review_write_sj' id="review_write_sj<%= myStamps[i].id %>">
                <div id="star_upload">
                  <div class="star<%= myStamps[i].id %>">
                    <img class="gray<%= myStamps[i].id %>" id="gray1<%= myStamps[i].id %>"src="/images/star_gray.png" width="40px"height="40px">
                    <img class="yellow<%= myStamps[i].id %>" id="yellow1<%= myStamps[i].id %>"src="/images/star_yellow.png" width="40px"height="40px" style="display: none">
                  </div>
                  <div class="star<%= myStamps[i].id %>">
                      <img class="gray<%= myStamps[i].id %>" id="gray2<%= myStamps[i].id %>"src="/images/star_gray.png" width="40px"height="40px">
                    <img class="yellow<%= myStamps[i].id %>" id="yellow2<%= myStamps[i].id %>"src="/images/star_yellow.png" width="40px"height="40px" style="display: none">
                  </div>
                  <div class="star<%= myStamps[i].id %>">
                      <img class="gray<%= myStamps[i].id %>" id="gray3<%= myStamps[i].id %>"src="/images/star_gray.png" width="40px"height="40px">
                      <img class="yellow<%= myStamps[i].id %>" id="yellow3<%= myStamps[i].id %>"src="/images/star_yellow.png" width="40px"height="40px" style="display: none">
                  </div>
                  <div class="star<%= myStamps[i].id %>">
                      <img class="gray<%= myStamps[i].id %>" id="gray4<%= myStamps[i].id %>"src="/images/star_gray.png" width="40px"height="40px">
                      <img class="yellow<%= myStamps[i].id %>" id="yellow4<%= myStamps[i].id %>"src="/images/star_yellow.png" width="40px"height="40px" style="display: none">
                  </div>
                  <div class="star<%= myStamps[i].id %>">
                      <img class="gray<%= myStamps[i].id %>" id="gray5<%= myStamps[i].id %>"src="/images/star_gray.png" width="40px"height="40px">
                      <img class="yellow<%= myStamps[i].id %>" id="yellow5<%= myStamps[i].id %>"src="/images/star_yellow.png" width="40px"height="40px" style="display: none">
                  </div>
                </div>
                <p id="intro_star">만족도만큼 별을 클릭해 주세요</p>
                <div class="line"></div>
                <div id="write_div">리뷰 작성</div>

                <textarea class="review_textarea <%= myStamps[i].id %>" id='review_textarea<%= myStamps[i].id %>' rows="6"></textarea>
                <!-- <div class='write_button_div_sj' id="write_button_div_sj<%= myStamps[i].id %>"> -->
                  <button class="write_ok_button <%= myStamps[i].id %>" id='write_ok_button<%= myStamps[i].id %>'>등록</button>
                <!-- </div> -->
              </div>
            </div>


            </div>

            <div class="swiper-scrollbar"></div>
            </div>
            </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.3.3/js/swiper.min.js"></script>

            <script>
                var swiper = new Swiper('.swiper-container', {
                    autoHeight: true,
                    observer: true,
                    observeParents: true,
                    scrollbar: {
                        el: '.swiper-scrollbar',
                        hide: true,
                    },
                });

            </script>
            <script>
            var number1 = "";
            $('#stamp_list<%= myStamps[i].id %>').click(function () {
              // 스크롤 조절
              window.scrollTo(0, 0);
              $('#selected_stamp<%= myStamps[i].id %>').css('display', 'block');
              $('#back_div<%= myStamps[i].id %>').css('display', 'block');
              $('#myStamp').css('display', 'none');
            });

            $('#back_div<%= myStamps[i].id %>').click(function () {
              $('#selected_stamp<%= myStamps[i].id %>').css('display', 'none');
              $('#back_div<%= myStamps[i].id %>').css('display', 'none');
              $('#myStamp').css('display', 'block');
            });

            var stamp_count<%= myStamps[i].id %> = parseInt('<%= myStamps[i].stamp_count %>');
            var stamp_standard<%= myStamps[i].id %> = '<%= myStamps[i].stamp_standard %>';
            var reset_stamp_count = 0;
            var new_stamp_count = parseInt(stamp_count<%= myStamps[i].id %>) + 1;
            console.log(stamp_count<%= myStamps[i].id %>);
            console.log('<%= myStamps[i].id %>');

            /* 스탬프 테마 적용 */


            /*  적립해놓은 스탬프 색칠  */
            if (stamp_standard<%= myStamps[i].id %> == 5) {
              $('#fiveControls_sj<%= myStamps[i].id %>').css('display', 'table');
              for (var i = 0; i < stamp_count<%= myStamps[i].id %>; i++) {
                var check = document.getElementsByClassName('five_sj <%= myStamps[i].id %>')[i];
                check.style.backgroundColor = "#232323";
              }
            }
            else if (stamp_standard<%= myStamps[i].id %> == 10) {
              $('#tenControls_sj<%= myStamps[i].id %>').css('display', 'table');
              for (var i = 0; i < stamp_count<%= myStamps[i].id %>; i++) {
                var check = document.getElementsByClassName('ten_sj <%= myStamps[i].id %>')[i];
                check.style.backgroundColor = "#232323";
              }
            }


            /*  가게 상세정보 각 탭 및 버튼 클릭 이벤트  */
            $('#go_stamp_sj<%= myStamps[i].id %>').click(function () {
              $('#stamp_menu_sj<%= myStamps[i].id %>').show(200);
              $('#store_detail_sj<%= myStamps[i].id %>').hide(200);
              $('#store_review_sj<%= myStamps[i].id %>').hide(200);
              $('#review_write_sj<%= myStamps[i].id %>').hide(200);
              $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
            })
            $('#go_store_detail_sj<%= myStamps[i].id %>').click(function () {
              $('#stamp_menu_sj<%= myStamps[i].id %>').hide(200);
              $('#store_detail_sj<%= myStamps[i].id %>').show(200);
              $('#store_review_sj<%= myStamps[i].id %>').hide(200);
              $('#review_write_sj<%= myStamps[i].id %>').hide(200);
              $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
            })
            $('#go_store_review_sj<%= myStamps[i].id %>').click(function () {
              $('#stamp_menu_sj<%= myStamps[i].id %>').hide(200);
              $('#store_detail_sj<%= myStamps[i].id %>').hide(200);
              $('#store_review_sj<%= myStamps[i].id %>').show(200);
              $('#review_write_sj<%= myStamps[i].id %>').hide(200);
              $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
            })
            $('#review_button_sj<%= myStamps[i].id %>').click(function () {
              $('#store_review_sj<%= myStamps[i].id %>').hide(200);
              $('#review_write_sj<%= myStamps[i].id %>').show(200);
              $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
            })
            $('#write_cancel_sj<%= myStamps[i].id %>').click(function () {
              $('#store_review_sj<%= myStamps[i].id %>').show(200);
              $('#review_write_sj<%= myStamps[i].id %>').hide(200);
              $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
            })


            /*  좋아요  */
            var good<%= myStamps[i].id %> = document.getElementById('goodCount_sj<%= myStamps[i].id %>');
            $('#noGood_Button_sj<%= myStamps[i].id %>').click(function () {
              var data = {
                'market_name' : '<%= myStamps[i].market_name %>',
                'sijang_name' : '<%= myStamps[i].sijang_name %>',
                'like_count' : parseInt(good<%= myStamps[i].id %>.textContent) + 1
              }
              $.ajax({
                type: 'post',
                url: '/like/<%= myStamps[i].id %>',
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                cache: false,
                data: data,
                datatype: 'json',
                success: function(result) {
                  if (result['result']=='success'){
                    console.log(result);
                    $('#noGood_Button_sj<%= myStamps[i].id %>').css('display', 'none');
                    $('#yesGood_Button_sj<%= myStamps[i].id %>').css('display', 'block');
                    good<%= myStamps[i].id %>.innerHTML = result['like'];
                  }
                },
                error: function(error){
                  console.log('좋아요 실패');
                }
              });
            });


            /* 좋아요 취소 */
            $('#yesGood_Button_sj<%= myStamps[i].id %>').click(function () {
              var data = {
                'market_name' : '<%= myStamps[i].market_name %>',
                'sijang_name' : '<%= myStamps[i].sijang_name %>',
                'like_count' : parseInt(good<%= myStamps[i].id %>.textContent) - 1
              }
              $.ajax({
                type: 'post',
                url: '/cancel_like/<%= myStamps[i].id %>',
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                cache: false,
                data: data,
                datatype: 'json',
                success: function(result) {
                  if (result['result']=='success'){
                    $('#yesGood_Button_sj<%= myStamps[i].id %>').css('display', 'none');
                    $('#noGood_Button_sj<%= myStamps[i].id %>').css('display', 'block');
                    good<%= myStamps[i].id %>.innerHTML = result['like'];
                  }
                },
                error: function(error){
                  console.log('좋아요 취소 실패');
                }
              });
            });


            /* 비밀번호 키패드 섞는 함수 */
            var password_number_array_sj = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'];
            function shuffle(a) {
              var j, x, i;
              for (i = a.length; i; i -= 1) {
                j = Math.floor(Math.random() * i);
                x = a[i - 1];
                a[i - 1] = a[j];
                a[j] = x;
              }
            }

            /*  리뷰 등록 시 별점 클릭 이벤트  */
            var starRate<%= myStamps[i].id %>;
            $('.star<%= myStamps[i].id %>').click(function(){
                $('.yellow<%= myStamps[i].id %>').css('display','none')
                  $('.gray<%= myStamps[i].id %>').css('display','block')
                var star_index=$(this).index();
                for(var i=0; i<star_index+1; i++){

                  document.getElementsByClassName('gray<%= myStamps[i].id %>')[i].style.display='none';
                  document.getElementsByClassName('yellow<%= myStamps[i].id %>')[i].style.display='block';

                }

                // alert(star_index+1)
                starRate<%= myStamps[i].id %> = star_index + 1;

              })

            /* 리뷰 작성 버튼 */
            var doubleSubmitFlag = false;
            function doubleSubmitCheck(){
              if(doubleSubmitFlag){
                return doubleSubmitFlag;
              }else{
                doubleSubmitFlag = true;
                return false;
              }
            }

            $('#write_ok_button<%= myStamps[i].id %>').click(function(){
              if(doubleSubmitCheck()) return;

              var user_id = '<%= myStamps[i].user_id %>';
              var market_name = '<%= myStamps[i].market_name %>';
              var text=$('#review_textarea<%= myStamps[i].id %>').val();
              var now = new Date();
              function leadingZeros(n, digits){
                var zero='';
                n = n.toString();
                if(n.length < digits){
                  for(i = 0 ; i < digits - n.length; i++){
                    zero += '0';
                  }
                }
                return zero + n;
              }
              var post_date = leadingZeros(now.getYear()-100,2)+ '-'+
                  leadingZeros(now.getMonth()+1,2)+'-' +
                  leadingZeros(now.getDate(),2);

              var sijang_name = '<%= myStamps[i].sijang_name %>';

              if(! text) {
                alert('내용을 입력해주세요 !');
                return false;
              }

              if(! starRate<%= myStamps[i].id %>) {
                starRate<%= myStamps[i].id %> = 0;
              }

              var data = {
                'market_name' : market_name,
                'user_id' : user_id,
                'date' : post_date,
                'review' : text,
                'sijang_name' : sijang_name,
                'rate': starRate<%= myStamps[i].id %>
              }
              console.log(data);
              $.ajax({
                type: 'post',
                url: '/review',
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                cache: false,
                data: data,
                datatype: 'json',
                success: function(result) {
                  if (result['result']=='success'){
                    // console.log(result);
                    alert('등록완료');
                    localStorage.setItem('reviewTab', '<%= myStamps[i].id %>');
                    location.reload();
                  }
                  else{
                    console.log(result);
                    alert('등록실패1');
                  }
                },
                error: function(error){
                  alert('등록실패2');
                  location.reload();
                }
              });
            });


            /*  스탬프 적립  */
            $('#stamp_sj<%= myStamps[i].id %>').click(function () {
              var count = 0; //쿠폰 클릭시 이벤트 발생
              var result = 1;
              $('#stamp_menu_sj<%= myStamps[i].id %>').hide(200);
              $('#password_number_div_sj<%= myStamps[i].id %>').show(200);

              shuffle(password_number_array_sj);

              for (var i = 0; i < 10; i++) {
                document.getElementsByClassName('password_number_sj <%= myStamps[i].id %>')[i].innerHTML = password_number_array_sj[i];
               }

              $('.password_number_sj').off().on('click',function(){
                console.log('<%= myStamps[i].stamp_count %>')
                number1 += $(this).html();
                $('.check<%= myStamps[i].id %>').eq(count).html('*')
                // document.getElementsByClassName('check<%= myStamps[i].id %>')[count].style.innerHTML='*';
                // $('.check:eq(count)').html('*')
                count++;

                console.log(number1);
                console.log("count"+count);
                if(count == 4){
                  count=0;
                  $.ajax({
                    type: 'POST',
                    url: '/stamp_count_password/<%= myStamps[i].id %>',
                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                    cache: false,
                    dataType: 'json',
                    success: function (result) {
                      if (result['password'] == number1) {
                        console.log(result['password']);
                        alert('비밀번호 일치');
                        if (parseInt('<%= myStamps[i].stamp_standard %>') >= stamp_count<%= myStamps[i].id %> + 1) {
                          var data = {
                            'stamp_count': stamp_count<%= myStamps[i].id %> + 1,
                          };
                          console.log(data);
                          $.ajax({
                            type: 'POST',
                            url: '/aboutstamp_count/<%= myStamps[i].id %>',
                            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                            cache: false,
                            dataType: 'json',
                            data: data,
                            success: function (result) {
                              if (result['result'] == 'success') {
                                alert('스탬프추가');
                                number1 = "";
                                $('.check<%= myStamps[i].id %>').html('');
                                console.log(result);
                                stamp_count<%= myStamps[i].id %> = parseInt(result['new_stamp_count']);
                                if (parseInt('<%= myStamps[i].stamp_standard %>') == 5) {
                                  $('#fiveControls_sj<%= myStamps[i].id %>').css('display', 'table');
                                  for (var i = 0; i < parseInt(stamp_count<%= myStamps[i].id %>); i++) {
                                    var check = document.getElementsByClassName('five_sj <%= myStamps[i].id %>')[i];
                                    check.style.backgroundColor = "#232323";
                                  }
                                }
                                else if (parseInt('<%= myStamps[i].stamp_standard %>') == 10) {
                                  $('#tenControls_sj<%= myStamps[i].id %>').css('display', 'table');
                                  for (var i = 0; i < parseInt(stamp_count<%= myStamps[i].id %>); i++) {
                                    var check = document.getElementsByClassName('ten_sj <%= myStamps[i].id %>')[i];
                                    check.style.backgroundColor = "#232323";
                                  }
                                }
                                $('#stamp_count_vertical<%= myStamps[i].id %>').html('<p class="count_stamp">'+ (stamp_count<%= myStamps[i].id %>) +' / <%= myStamps[i].stamp_standard %></p>');
                                $('#stamp_menu_sj<%= myStamps[i].id %>').show(200);
                                $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
                                // $(window).attr('location', '/myStamp');
                              }
                            },
                            error: function (error) {
                              console.log('error');
                            }
                          });
                        }
                        else {
                          var data = {
                            'stamp_count': reset_stamp_count,
                          };
                          $.ajax({
                            type: 'POST',
                            url: '/reset_aboutstamp_count/<%= myStamps[i].id %>',
                            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                            cache: false,
                            dataType: 'json',
                            data: data,
                            success: function (result) {
                              if (result['result'] == 'successs') {
                                alert('초기화');
                                number1 = "";
                                stamp_count<%= myStamps[i].id %> = 0;
                                if (parseInt('<%= myStamps[i].stamp_standard %>') == 5) {
                                  $('#fiveControls_sj<%= myStamps[i].id %>').css('display', 'table');
                                  for (var i = 0; i < 5; i++) {
                                    var check = document.getElementsByClassName('five_sj <%= myStamps[i].id %>')[i];
                                    check.style.backgroundColor = "rgb(202, 199, 199)";
                                  }
                                }
                                else if (parseInt('<%= myStamps[i].stamp_standard %>') == 10) {
                                  $('#tenControls_sj<%= myStamps[i].id %>').css('display', 'table');
                                  for (var i = 0; i < 10; i++) {
                                    var check = document.getElementsByClassName('ten_sj <%= myStamps[i].id %>')[i];
                                    check.style.backgroundColor = "rgb(202, 199, 199)";
                                  }
                                }
                                $('#stamp_count_vertical<%= myStamps[i].id %>').html('<p class="count_stamp">'+ (reset_stamp_count) +' / <%= myStamps[i].stamp_standard %></p>');
                                $('#stamp_menu_sj<%= myStamps[i].id %>').show(200);
                                $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
                                $('.check<%= myStamps[i].id %>').html('');
                                // $(window).attr('location', '/myStamp');
                              }
                            },
                            error: function (error) {
                              console.log('error');
                            }
                          });
                        }
                        //
                      } else {
                        console.log(result['password']);
                        console.log(number1);
                        alert('비밀번호가 일치하지 않습니다. 다시 입력해주세요.');
                        number1 = "";
                        $('.check<%= myStamps[i].id %>').html('');
                      }
                    },
                    error: function (error) {
                      console.log('error');
                    }
                  });
                }
              })
            });


            /* 비밀번호 키패드에서 취소 버튼 눌렀을 때 */
            $('#password_cancel<%= myStamps[i].id %>').click(function(){
              $('.check<%= myStamps[i].id %>').html('');
              $('#password_number_div_sj<%= myStamps[i].id %>').hide(200);
              $('#stamp_menu_sj<%= myStamps[i].id %>').show(200);
            });


            /*  발급 받은 스탬프 삭제  */
            $("#delete_button_sj<%= myStamps[i].id %>").click(function() {
              // delete ajax
              $.ajax({
                type: 'post',
                url: '/delete_stamp/<%= myStamps[i].id %>',
                contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                cache: false,
                datatype: 'json',
                success: function(result) {
                  if (result['result']=='success'){
                    alert('해당 스탬프의 삭제가 완료되었습니다.');
                    // delete stamp list
                    // var stamp = document.getElementById('stamp_list<%= myStamps[i].id %>');
                    // stamp.parentNode.removeChild(stamp);
                    // delete selected stamp
                    // var selected_stamp = document.getElementById('selected_stamp<%= myStamps[i].id %>');
                    // selected_stamp.parentNode.removeChild(selected_stamp);
                    // $('#myStamp').css('display', 'block');
                    location.reload();
                  }
                },
                error: function(error){
                  alert('삭제 실패');
                }
              });
            });

            </script>
            <% } %>
          </div>
            <% } %>

            <div id="nav_sj">
                <div id="home_sj">
                    <img src="/images/home.png" width="40%">
                    <p>홈</p></div>
                <div id="coupon_sj">
                    <img src="/images/coupon.png" width="40%">
                    <p>쿠폰</p></div>
                <div id="location_sj">
                    <img src="/images/location.png" width="40%">
                    <p>주변 가맹점</p></div>
                <div id="myStamp_sj">
                    <img src="/images/stamp2.png" width="40%">
                    <p id="nav_text">내 스탬프</p></div>
                    <div id="logout">
                        <img src="/images/logout.png" width="40%">
                        <p>로그아웃</p>
                    </div>
            </div>
            <script>

                // $('.store_image').css({ "background": "url(/images/market3.jpg)", 'background-repeat': 'no-repeat', 'background-position': 'center center' });
                      $('#home_sj').click(function () {
                        location.href = "/main";
                      })
                      $('#coupon_sj').click(function () {
                        location.href = "/coupon";
                      })
                      $('#logout').click(function () {
                              var logout = confirm("로그아웃 하시겠습니까?");
                              if (logout == true) {
                                console.log('로그아웃성공');
                                $(location).attr('href','/logout');
                              } else {
                                console.log('로그아웃실패');
                              }
                          })



                      </script>

                    </body>

                    </html>
